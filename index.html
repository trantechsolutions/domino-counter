<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Domino Counter AI</title>
    <!-- Load TensorFlow.js and the COCO-SSD model -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom focus-visible styles for better accessibility */
        button:focus-visible, input:focus-visible {
            outline: 2px solid #4f46e5;
            outline-offset: 2px;
        }
        /* Loading spinner animation */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6 space-y-6">
        
        <header class="text-center">
            <h1 class="text-3xl font-bold text-gray-800">Domino Counter</h1>
            <p class="text-gray-500">Mexican Train Scorer</p>
        </header>

        <!-- Camera and Canvas Section -->
        <div id="video-container" class="relative bg-gray-900 rounded-lg overflow-hidden border-2 border-gray-200">
            <video id="video" playsinline autoplay muted class="w-full h-auto block"></video>
            <canvas id="overlay-canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
            <div id="loading-overlay" class="absolute inset-0 bg-gray-900 bg-opacity-75 flex-col items-center justify-center hidden">
                <div class="loader"></div>
                <p id="loading-text" class="text-white mt-4">Starting Camera...</p>
            </div>
        </div>

        <!-- Controls Section -->
        <div id="controls-section">
            <button id="start-button" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none">
                Start Camera & Load AI
            </button>
            <button id="scan-button" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none hidden">
                Scan Domino
            </button>
        </div>

        <!-- Results Display -->
        <div id="results-section" class="grid grid-cols-2 gap-4 text-center hidden">
            <div class="bg-gray-100 p-4 rounded-lg">
                <h2 class="text-sm font-medium text-gray-500">Current Scan</h2>
                <p id="current-count" class="text-4xl font-bold text-indigo-600">0</p>
            </div>
            <div class="bg-gray-100 p-4 rounded-lg">
                <h2 class="text-sm font-medium text-gray-500">Total Score</h2>
                <p id="total-score" class="text-4xl font-bold text-gray-800">0</p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div id="actions-section" class="grid grid-cols-2 gap-4 hidden">
            <button id="add-button" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-600 transition-all duration-200">Add to Total</button>
            <button id="reset-button" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-red-600 transition-all duration-200">Reset All</button>
        </div>

        <!-- Instructions -->
        <div class="bg-indigo-50 border-l-4 border-indigo-500 text-indigo-800 p-4 rounded-r-lg">
            <h3 class="font-bold">Tips for Best Results</h3>
            <ul class="list-disc list-inside text-sm mt-2">
                <li>Use a plain, light-colored background.</li>
                <li>Ensure good, even lighting without harsh shadows.</li>
                <li>Scan one domino at a time, holding it steady.</li>
                <li>The AI is looking for dot-like shapes.</li>
            </ul>
        </div>
    </div>

<script>
    // DOM Element References
    const video = document.getElementById('video');
    const startButton = document.getElementById('start-button');
    const scanButton = document.getElementById('scan-button');
    const addButton = document.getElementById('add-button');
    const resetButton = document.getElementById('reset-button');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    
    const overlayCanvas = document.getElementById('overlay-canvas');
    const overlayCtx = overlayCanvas.getContext('2d');

    const currentCountEl = document.getElementById('current-count');
    const totalScoreEl = document.getElementById('total-score');
    
    const resultsSection = document.getElementById('results-section');
    const actionsSection = document.getElementById('actions-section');

    // App State
    let currentScanValue = 0;
    let totalScore = 0;
    let model = null; // To hold the loaded AI model

    // --- Event Listeners ---
    startButton.addEventListener('click', setupApp);
    scanButton.addEventListener('click', scanDomino);
    
    addButton.addEventListener('click', () => {
        totalScore += currentScanValue;
        currentScanValue = 0;
        updateUI();
        overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
    });

    resetButton.addEventListener('click', () => {
        currentScanValue = 0;
        totalScore = 0;
        updateUI();
        overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
    });

    // --- Core Functions ---
    async function setupApp() {
        loadingOverlay.classList.remove('hidden');
        loadingOverlay.classList.add('flex');
        startButton.disabled = true;
        startButton.classList.add('opacity-50');

        // Step 1: Start the camera
        loadingText.textContent = "Starting Camera...";
        const stream = await startCamera();
        if (!stream) {
            // Handle camera start failure
            loadingOverlay.classList.add('hidden');
            startButton.disabled = false;
            startButton.classList.remove('opacity-50');
            return;
        }

        // Step 2: Load the AI model
        loadingText.textContent = "Loading AI Model...";
        try {
            model = await cocoSsd.load();
        } catch (err) {
            console.error("Failed to load model", err);
            alert("Failed to load the AI model. Please check your internet connection and try again.");
            loadingOverlay.classList.add('hidden');
            startButton.disabled = false;
            startButton.classList.remove('opacity-50');
            return;
        }

        // Step 3: Finalize UI
        startButton.classList.add('hidden');
        scanButton.classList.remove('hidden');
        resultsSection.classList.remove('hidden');
        actionsSection.classList.remove('hidden');
        loadingOverlay.classList.add('hidden');
        loadingOverlay.classList.remove('flex');
    }

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment' } // Prefer rear camera
            });
            video.srcObject = stream;
            return new Promise(resolve => {
                video.onloadedmetadata = () => {
                    video.play();
                    // Set canvas sizes to match video dimensions
                    overlayCanvas.width = video.videoWidth;
                    overlayCanvas.height = video.videoHeight;
                    resolve(stream);
                };
            });
        } catch (err) {
            console.error("Camera Error:", err);
            alert('Could not access the camera. Please ensure you grant permission and are using a secure (https) connection.');
            return null;
        }
    }

    function updateUI() {
        currentCountEl.textContent = currentScanValue;
        totalScoreEl.textContent = totalScore;
    }
    
    async function scanDomino() {
        if (!model || !video.srcObject) {
            alert("AI Model or Camera not ready.");
            return;
        }

        try {
            // 1. Use the AI model to detect objects in the video frame
            const predictions = await model.detect(video);

            // 2. Filter predictions to find likely domino dots
            // We'll accept any small object with a high confidence score.
            // The aspect ratio check helps ensure we get dot-like shapes.
            const detectedDots = predictions.filter(p => {
                const [x, y, width, height] = p.bbox;
                const aspectRatio = width / height;
                return p.score > 0.65 && aspectRatio > 0.7 && aspectRatio < 1.3;
            });

            // 3. Update application state and UI
            currentScanValue = detectedDots.length;
            updateUI();

            // 4. Draw detection boxes on the overlay canvas
            drawDetections(detectedDots);

        } catch (e) {
            console.error("AI Prediction Error:", e);
            alert("An error occurred while scanning the image. Please try again.");
        }
    }

    /**
     * Draws bounding boxes on the overlay canvas to mark detected dots.
     * @param {Array} predictions - An array of prediction objects from the AI model.
     */
    function drawDetections(predictions) {
        overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
        
        predictions.forEach(prediction => {
            const [x, y, width, height] = prediction.bbox;
            const text = `${(prediction.score * 100).toFixed(1)}%`;

            // Bounding box
            overlayCtx.strokeStyle = '#2ecc71'; // A nice green
            overlayCtx.lineWidth = 2;
            overlayCtx.strokeRect(x, y, width, height);

            // Text background
            overlayCtx.fillStyle = '#2ecc71';
            const textWidth = overlayCtx.measureText(text).width;
            overlayCtx.fillRect(x, y, textWidth + 8, 20);

            // Text
            overlayCtx.fillStyle = '#ffffff';
            overlayCtx.font = '14px Inter';
            overlayCtx.fillText(text, x + 4, y + 14);
        });
    }
</script>
</body>
</html>
