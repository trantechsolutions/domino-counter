<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Domino Counter AI</title>
    <!-- Load TensorFlow.js and the COCO-SSD model -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom focus-visible styles for better accessibility */
        button:focus-visible, input:focus-visible {
            outline: 2px solid #4f46e5;
            outline-offset: 2px;
        }
        /* Loading spinner animation */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6 space-y-6">
        
        <header class="text-center">
            <h1 class="text-3xl font-bold text-gray-800">Pip Tracker</h1>
            <p class="text-gray-500">Real-time Domino Dot Counter</p>
        </header>

        <!-- Camera and Canvas Section -->
        <div id="video-container" class="relative bg-gray-900 rounded-lg overflow-hidden border-2 border-gray-200">
            <video id="video" playsinline autoplay muted class="w-full h-auto block"></video>
            <canvas id="overlay-canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
            <div id="loading-overlay" class="absolute inset-0 bg-gray-900 bg-opacity-75 flex-col items-center justify-center hidden">
                <div class="loader"></div>
                <p id="loading-text" class="text-white mt-4">Starting Camera...</p>
            </div>
        </div>

        <!-- Real-time Count Display -->
        <div id="count-display" class="text-center bg-gray-100 p-4 rounded-lg hidden">
            <h2 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Detected Pips</h2>
            <p id="pip-count" class="text-7xl font-extrabold text-indigo-600">0</p>
        </div>

        <!-- Controls Section -->
        <div id="controls-section" class="mt-4">
            <button id="start-button" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none">
                Start Camera
            </button>
            <button id="stop-button" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-red-700 transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none hidden">
                Stop Camera
            </button>
        </div>

        <!-- Instructions -->
        <div class="bg-indigo-50 border-l-4 border-indigo-500 text-indigo-800 p-4 rounded-r-lg">
            <h3 class="font-bold">Tips for Best Results</h3>
            <ul class="list-disc list-inside text-sm mt-2">
                <li>Use a plain, light-colored background.</li>
                <li>Ensure good, even lighting without harsh shadows.</li>
                <li>Hold the domino steady to get a clear count.</li>
                <li>The AI is looking for small, round shapes.</li>
            </ul>
        </div>
    </div>

<script>
    // DOM Element References
    const video = document.getElementById('video');
    const startButton = document.getElementById('start-button');
    const stopButton = document.getElementById('stop-button');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    
    const overlayCanvas = document.getElementById('overlay-canvas');
    const overlayCtx = overlayCanvas.getContext('2d');

    const countDisplay = document.getElementById('count-display');
    const pipCountEl = document.getElementById('pip-count');
    
    // App State
    let model = null; // To hold the loaded AI model
    let isDetecting = false;
    let animationFrameId = null;

    // --- Event Listeners ---
    startButton.addEventListener('click', startApp);
    stopButton.addEventListener('click', stopApp);

    // --- Core Functions ---
    async function startApp() {
        loadingOverlay.classList.remove('hidden');
        loadingOverlay.classList.add('flex');
        startButton.disabled = true;
        startButton.classList.add('opacity-50');

        // Step 1: Load the AI model if it's not already loaded
        if (!model) {
            loadingText.textContent = "Loading AI Model...";
            try {
                model = await cocoSsd.load();
            } catch (err) {
                console.error("Failed to load model", err);
                alert("Failed to load the AI model. Please check your internet connection and try again.");
                stopApp(); // Reset UI
                return;
            }
        }

        // Step 2: Start the camera
        loadingText.textContent = "Starting Camera...";
        const stream = await startCamera();
        if (!stream) {
            stopApp(); // Reset UI on failure
            return;
        }

        // Step 3: Finalize UI and start detection loop
        startButton.classList.add('hidden');
        stopButton.classList.remove('hidden');
        countDisplay.classList.remove('hidden');
        loadingOverlay.classList.add('hidden');
        loadingOverlay.classList.remove('flex');

        isDetecting = true;
        detectLoop();
    }

    function stopApp() {
        isDetecting = false;
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }

        // Stop the camera stream
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
        
        // Reset UI
        overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
        pipCountEl.textContent = '0';
        countDisplay.classList.add('hidden');
        stopButton.classList.add('hidden');
        startButton.classList.remove('hidden');
        startButton.disabled = false;
        startButton.classList.remove('opacity-50');
    }

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment' } // Prefer rear camera
            });
            video.srcObject = stream;
            return new Promise(resolve => {
                video.onloadedmetadata = () => {
                    video.play();
                    overlayCanvas.width = video.videoWidth;
                    overlayCanvas.height = video.videoHeight;
                    resolve(stream);
                };
            });
        } catch (err) {
            console.error("Camera Error:", err);
            alert('Could not access the camera. Please ensure you grant permission and are using a secure (https) connection.');
            return null;
        }
    }

    async function detectLoop() {
        if (!isDetecting) return;

        // 1. Use the AI model to detect objects in the video frame
        const predictions = await model.detect(video);

        // 2. Filter predictions to find likely domino dots
        const detectedDots = predictions.filter(p => {
            const [x, y, width, height] = p.bbox;
            const aspectRatio = width / height;
            // Loosening the confidence requirement slightly can help in varied lighting
            return p.score > 0.60 && aspectRatio > 0.7 && aspectRatio < 1.3;
        });

        // 3. Update UI with the count
        pipCountEl.textContent = detectedDots.length;

        // 4. Draw detection circles on the overlay canvas
        drawDetections(detectedDots);

        // 5. Request the next frame
        animationFrameId = requestAnimationFrame(detectLoop);
    }

    /**
     * Draws circles on the overlay canvas to mark detected dots.
     * @param {Array} predictions - An array of prediction objects from the AI model.
     */
    function drawDetections(predictions) {
        overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
        
        predictions.forEach(prediction => {
            const [x, y, width, height] = prediction.bbox;
            const centerX = x + width / 2;
            const centerY = y + height / 2;
            const radius = (width + height) / 4;

            // Draw the circle
            overlayCtx.beginPath();
            overlayCtx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            overlayCtx.fillStyle = 'rgba(46, 204, 113, 0.3)'; // Semi-transparent green fill
            overlayCtx.fill();
            overlayCtx.strokeStyle = 'rgba(46, 204, 113, 0.8)'; // Solid green border
            overlayCtx.lineWidth = 2;
            overlayCtx.stroke();
        });
    }
</script>
</body>
</html>
